<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUN City</title>
    <link rel="stylesheet" href="../css/start-screen.css">
</head>
<body>
    <!-- Character Selection Screen -->
    <div class="screen character-selection" id="characterSelection">
        <h1 id="selectionTitle">Player 1: Drag your avatar to the box below</h1>
        <!-- 
        <div class="characters">
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../images/julio.jpg">
                <img src="../images/julio.jpg" alt="Player 1">
            </div>
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../images/florent.jpg">
                <img src="../images/florent.jpg" alt="Player 2">
            </div>
        </div>
        -->
        
        <!-- Player selection -->
        <div class="characters">
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../../ressources/images/player-img/avatar_hitman.png">
                <img src="../../ressources/images/player-img/avatar_hitman.png" alt="Hitman">
            </div>
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../../ressources/images/player-img/avatar_soldier.png">
                <img src="../../ressources/images/player-img/avatar_soldier.png" alt="Soldier">
            </div>
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../../ressources/images/player-img/avatar_survivor.png">
                <img src="../../ressources/images/player-img/avatar_survivor.png" alt="Survivor">
            </div>
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../../ressources/images/player-img/avatar_woman.png">
                <img src="../../ressources/images/player-img/avatar_woman.png" alt="Woman">
            </div>
        </div>
        

        <div class="drop-box" id="playerDropBox" ondrop="drop(event)" ondragover="allowDrop(event)">
            Drop your character here
        </div>
        <input type="text" id="playerNameInput" class="player-name-input" placeholder="Enter your name">
        <button onclick="continueToNextStep()">CONTINUE</button>
    </div>

    <!-- Recap Screen -->
    <div class="screen recap" id="recapScreen">
        <h1>Players Ready!</h1>

        <div class="player-recap">
            <div class="avatar-wrapper">
                <img id="recapP1">
            </div>
            <div class="player-info">
                <h2 id="recapName1">Player 1</h2>
                <div class="location-box">
                    <p id="location1Display">üìç Detecting location...</p>
                    <button onclick="toggleLocationInput('1')">Change Location</button>
                    <div class="manualInput" id="manualInput1">
                        <input type="text" id="manualCity1" placeholder="City">
                        <input type="text" id="manualCountry1" placeholder="Country">
                        <button onclick="setManualLocation('1')">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="player-recap">
            <div class="avatar-wrapper">
                <img id="recapP2">
            </div>
            <div class="player-info">
                <h2 id="recapName2">Player 2</h2>
                <div class="location-box">
                    <p id="location2Display">üìç Detecting location...</p>
                    <button onclick="toggleLocationInput('2')">Change Location</button>
                    <div class="manualInput" id="manualInput2">
                        <input type="text" id="manualCity2" placeholder="City">
                        <input type="text" id="manualCountry2" placeholder="Country">
                        <button onclick="setManualLocation('2')">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="startCountdown()">CONTINUE</button>
    </div>

    <script>
        /*
            Configuration and state 
        */
        const countryCodeMap = {
            "Switzerland": "CH",
            "Schweiz": "CH",
            "Suisse": "CH",
            "Germany": "DE",
            "Deutschland": "DE",
            "Allemagne": "DE",
            "France": "FR",
            "Frankreich": "FR",
            "Austria": "AT",
            "√ñsterreich": "AT",
            "Austriche": "AT",
            "Italy": "IT",
            "Italien": "IT",
            "Italie": "IT",
            "Spain": "ES",
            "Spanien": "ES",
            "Espagne": "ES",
            "United Kingdom": "GB",
            "Vereinigtes K√∂nigreich": "GB",
            "Royaume-Uni": "GB",
            "United States": "US",
            "Vereinigte Staaten": "US",
            "√âtats-Unis": "US",
        };
        let step = 1;
        let selectedPlayers = { player1: null, player2: null };
        let playerNames = { player1: "Player 1", player2: "Player 2" };
        const manualLocations = { "1": null, "2": null };
        let apiConfig = null;

        /*
            Helper methods
        */

        // Convert 2-letter country code to emoji flag
        function toCountryCodeEmoji(code) {
            return code.toUpperCase().replace(/./g, char =>
                String.fromCodePoint(127397 + char.charCodeAt()));
        }

        // Load API key + URL from external JSON
        async function loadApiConfig() {
            try {
                const response = await fetch('../../configuration/apiConfig.json');
                apiConfig = await response.json();
            } catch (error) {
                console.error("Could not load API config:", error);
            }
        }

        // Check if manual or automatic location is available
        function isLocationAvailable(playerId) {
            const display = document.getElementById(`location${playerId}Display`);
            const value = display.innerText || display.textContent;
            return manualLocations[playerId] || (value && !value.startsWith("‚ùå") && !value.includes("Detecting location"));
        }

        /*
            UI interactions
        */

        // Enable dropping avatar into box
        function allowDrop(ev) { ev.preventDefault(); }

        // Set dragged image to transfer
        function drag(ev) {
            const img = ev.target.tagName === "IMG" ? ev.target : ev.target.querySelector("img");
            ev.dataTransfer.setData("text/plain", img.src);
        }

        // Drop avatar and assign it to current player step
        function drop(ev) {
            ev.preventDefault();
            const fullImgSrc = ev.dataTransfer.getData("text/plain");

            // Extract only the file name
            const filename = fullImgSrc.split("/").pop();

            // Match filename to index
            const indexMap = {
                "avatar_soldier.png": "0",
                "avatar_hitman.png": "1",
                "avatar_survivor.png": "2",
                "avatar_woman.png": "3"
            };

            const index = indexMap[filename] ?? "0";

            const dropBox = document.getElementById("playerDropBox");
            dropBox.innerHTML = "";
            const img = document.createElement("img");
            img.src = fullImgSrc;
            img.alt = step === 1 ? "Player 1" : "Player 2";
            dropBox.appendChild(img);

            if (step === 1) {
                selectedPlayers.player1 = { index: index, avatar: fullImgSrc };
            } else {
                selectedPlayers.player2 = { index: index, avatar: fullImgSrc };
            }
        }

        // Continue to next player or show recap
        function continueToNextStep() {
            const nameInput = document.getElementById("playerNameInput").value.trim();

            if (step === 1 && !selectedPlayers.player1) {
                alert("Player 1 must choose a character!");
                return;
            }
            if (step === 2 && !selectedPlayers.player2) {
                alert("Player 2 must choose a character!");
                return;
            }

            if (step === 1) {
                if (nameInput) playerNames.player1 = nameInput;
                step++;
                document.getElementById("selectionTitle").innerText = "Player 2: Drag your avatar to the box below";
                document.getElementById("playerDropBox").innerHTML = "Drop your character here";
                document.getElementById("playerNameInput").value = "";
            } else {
                if (nameInput) playerNames.player2 = nameInput;

                // Ensure selections are persisted immediately
                persistPlayerSelection();

                document.getElementById("characterSelection").classList.add("hide");
                setTimeout(() => {
                    document.getElementById("characterSelection").style.display = "none";
                    showRecapScreen();
                }, 1000);
            }
        }

        // Fill in recap screen and trigger geolocation
        function showRecapScreen() {
            document.getElementById("recapP1").src = selectedPlayers.player1.avatar;
            document.getElementById("recapP2").src = selectedPlayers.player2.avatar;
            document.getElementById("recapName1").innerText = playerNames.player1;
            document.getElementById("recapName2").innerText = playerNames.player2;
            document.getElementById("recapScreen").style.display = "flex";
            fetchLocationForPlayer("1");
            fetchLocationForPlayer("2");

            persistPlayerSelection();
        }

        // Prevent starting game without valid location
        function startCountdown() {
            const missing = [];
            if (!isLocationAvailable("1")) missing.push("Player 1");
            if (!isLocationAvailable("2")) missing.push("Player 2");
            if (missing.length > 0) {
                alert(`${missing.join(" and ")} must provide a location to continue.`);
                return;
            }
            window.location.href = 'countdown.html';
        }

        // Manually input fallback location if needed
        function toggleLocationInput(playerId) {
            const container = document.getElementById(`manualInput${playerId}`);
            const changeButton = container.previousElementSibling;
            const isVisible = container.style.display === "block";
            container.style.display = isVisible ? "none" : "block";
            changeButton.style.display = isVisible ? "inline-block" : "none";
        }

        // Save manual location and update display
        function setManualLocation(playerId) {
            const city = document.getElementById(`manualCity${playerId}`).value.trim();
            const country = document.getElementById(`manualCountry${playerId}`).value.trim();
            const displayDiv = document.getElementById(`location${playerId}Display`);
            if (city && country) {
                manualLocations[playerId] = { city, country };
                const code = countryCodeMap[country] || null;
                const emoji = code ? toCountryCodeEmoji(code) : "üìç";
                displayDiv.innerHTML = `${emoji} ${city}, ${country}<br>‚úèÔ∏è <em>Manually entered</em>`;
                document.getElementById(`manualInput${playerId}`).style.display = "none";
                const changeButton = displayDiv.parentElement.querySelector("button");
                changeButton.style.display = "inline-block";
            } else {
                alert("Please enter both city and country.");
            }
        }

        // Attempt automatic location detection via API (OpenCage)
        async function fetchLocationForPlayer(playerId) {
            const displayDiv = document.getElementById(`location${playerId}Display`);
            if (!navigator.geolocation) {
                displayDiv.textContent = "‚ùå Geolocation not supported";
                return;
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                if (!apiConfig) await loadApiConfig();
                if (!apiConfig?.apiUrl || !apiConfig?.apiKey) {
                    displayDiv.textContent = "‚ùå API config missing";
                    return;
                }
                try {
                    const res = await fetch(`${apiConfig.apiUrl}?q=${lat}+${lon}&key=${apiConfig.apiKey}`);
                    const data = await res.json();
                    if (manualLocations[playerId]) return;
                    const result = data.results?.[0];
                    const components = result?.components;
                    const city = components?.city || components?.town || components?.village || components?.county;
                    const country = components?.country;
                    if (city && country) {
                        const code = countryCodeMap[country] || null;
                        const emoji = code ? toCountryCodeEmoji(code) : "üìç";
                        displayDiv.innerHTML = `${emoji} ${city}, ${country}`;
                    } else {
                        displayDiv.textContent = "‚ùå Location data incomplete";
                    }
                } catch (err) {
                    displayDiv.textContent = "‚ùå Location fetch error";
                    console.error("API error:", err);
                }
            }, () => {
                displayDiv.textContent = "‚ùå Permission denied or unavailable";
            });
        }

        // Show initial screen
        document.getElementById("characterSelection").style.display = "flex";
    </script>
    <script>
         const avatarToIndexMap = {
            "../../ressources/images/player-img/avatar_soldier.png": "0",
            "../../ressources/images/player-img/avatar_hitman.png": "1",
            "../../ressources/images/player-img/avatar_survivor.png": "2",
            "../../ressources/images/player-img/avatar_woman.png": "3"
        };

        function persistPlayerSelection() {
            const p1Index = selectedPlayers.player1?.index ?? "0";
            const p2Index = selectedPlayers.player2?.index ?? "1";  // fallback to hitman if missing

            localStorage.setItem("player1Name", playerNames.player1);
            localStorage.setItem("player2Name", playerNames.player2);
            localStorage.setItem("player1Img", p1Index);
            localStorage.setItem("player2Img", p2Index);
        }
    </script>
</body>
</html>