<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUN City</title>
    <link rel="stylesheet" href="../css/start-screen.css">
</head>
<body>
    <div class="screen character-selection" id="characterSelection">
        <h1 id="selectionTitle">Player 1: Drag your avatar to the box below</h1>
        <div class="characters">
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../images/julio.jpg">
                <img src="../images/julio.jpg" alt="Player 1">
            </div>
            <div class="character" draggable="true" ondragstart="drag(event)" data-img="../images/florent.jpg">
                <img src="../images/florent.jpg" alt="Player 2">
            </div>
        </div>
        <div class="drop-box" id="playerDropBox" ondrop="drop(event)" ondragover="allowDrop(event)">
            Drop your character here
        </div>
        <!-- player name input -->
        <input type="text" id="playerNameInput" class="player-name-input" placeholder="Enter your name">
        <button onclick="continueToNextStep()">CONTINUE</button>
    </div>

    <!-- recap summary -->
    <div class="screen recap" id="recapScreen">
        <h1>Players Ready!</h1>

        <div class="player-recap">
            <div class="avatar-wrapper">
                <img id="recapP1">
            </div>
            <div class="player-info">
                <h2 id="recapName1">Player 1</h2>
                <div class="location-box">
                    <p id="location1Display">üìç Detecting location...</p>
                    <button onclick="toggleLocationInput('1')">Change Location</button>
                    <div class="manualInput" id="manualInput1">
                        <input type="text" id="manualCity1" placeholder="City">
                        <input type="text" id="manualCountry1" placeholder="Country">
                        <button onclick="setManualLocation('1')">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="player-recap">
            <div class="avatar-wrapper">
                <img id="recapP2">
            </div>
            <div class="player-info">
                <h2 id="recapName2">Player 2</h2>
                <div class="location-box">
                    <p id="location2Display">üìç Detecting location...</p>
                    <button onclick="toggleLocationInput('2')">Change Location</button>
                    <div class="manualInput" id="manualInput2">
                        <input type="text" id="manualCity2" placeholder="City">
                        <input type="text" id="manualCountry2" placeholder="Country">
                        <button onclick="setManualLocation('2')">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <button onclick="startCountdown()">CONTINUE</button>
    </div>


    <script>
        // static country map code (multiple languages)
        const countryCodeMap = {
            "Switzerland": "CH",
            "Schweiz": "CH",
            "Suisse": "CH",
            "Germany": "DE",
            "Deutschland": "DE",
            "Allemagne": "DE",
            "France": "FR",
            "Frankreich": "FR",
            "Austria": "AT",
            "√ñsterreich": "AT",
            "Austriche": "AT",
            "Italy": "IT",
            "Italien": "IT",
            "Italie": "IT",
            "Spain": "ES",
            "Spanien": "ES",
            "Espagne": "ES",
            "United Kingdom": "GB",
            "Vereinigtes K√∂nigreich": "GB",
            "Royaume-Uni": "GB",
            "United States": "US",
            "Vereinigte Staaten": "US",
            "√âtats-Unis": "US",
        };

        // function to get country code from country name
        function toCountryCodeEmoji(code) {
            return code.toUpperCase()
                .replace(/./g, char =>
                    String.fromCodePoint(127397 + char.charCodeAt()));
        }

        let step = 1;
        let selectedPlayers = { player1: null, player2: null };
        let playerNames = { player1: "Player 1", player2: "Player 2" };
        const manualLocations = { "1": null, "2": null };
        let apiConfig = null;

        async function loadApiConfig() {
        try {
            const response = await fetch('../../configuration/apiConfig.json');
            apiConfig = await response.json();
        } catch (error) {
            console.error("Could not load API config:", error);
        }
    }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            const img = ev.target.tagName === "IMG" ? ev.target : ev.target.querySelector("img");
            ev.dataTransfer.setData("text/plain", img.src);
        }

        function drop(ev) {
            ev.preventDefault();
            const imgSrc = ev.dataTransfer.getData("text/plain");

            const dropBox = document.getElementById("playerDropBox");
            dropBox.innerHTML = "";
            const img = document.createElement("img");
            img.src = imgSrc;
            img.alt = step === 1 ? "Player 1" : "Player 2";
            dropBox.appendChild(img);

            if (step === 1) {
                selectedPlayers.player1 = imgSrc;
            } else {
                selectedPlayers.player2 = imgSrc;
            }
        }

        /*
        document.getElementById("characterSelection").style.display = "flex";

        function selectCharacter(element, player, imgSrc) {
            let characters = document.querySelectorAll(".character");
            characters.forEach(char => char.classList.remove("selected"));
            element.classList.add("selected");

            if (step === 1) {
                selectedPlayers.player1 = imgSrc;
            } else {
                selectedPlayers.player2 = imgSrc;
            }
        }
        */
        
        function continueToNextStep() {
            const nameInput = document.getElementById("playerNameInput").value.trim();

            if (step === 1 && selectedPlayers.player1 === null) {
                alert("Player 1 must choose a character!");
                return;
            }
            if (step === 2 && selectedPlayers.player2 === null) {
                alert("Player 2 must choose a character!");
                return;
            }

            if (step === 1) {
                if (nameInput) playerNames.player1 = nameInput;
                step++;
                document.getElementById("selectionTitle").innerText = "Player 2: Drag your avatar to the box below";
                document.getElementById("playerDropBox").innerHTML = "Drop your character here";
                document.getElementById("playerNameInput").value = "";
            } else {
                if (nameInput) playerNames.player2 = nameInput;
                document.getElementById("characterSelection").classList.add("hide");
                setTimeout(() => {
                    document.getElementById("characterSelection").style.display = "none";
                    showRecapScreen();
                }, 1000);
            }
        }


        function showRecapScreen() {
            document.getElementById("recapP1").src = selectedPlayers.player1;
            document.getElementById("recapP2").src = selectedPlayers.player2;
            document.getElementById("recapName1").innerText = playerNames.player1;
            document.getElementById("recapName2").innerText = playerNames.player2;
            document.getElementById("recapScreen").style.display = "flex";

            // fetch locations with api
            fetchLocationForPlayer("1");
            fetchLocationForPlayer("2");
        }

        function startCountdown() {
            window.location.href = 'countdown.html';
        }

        document.getElementById("characterSelection").style.display = "flex";

        async function fetchLocationForPlayer(playerId) {
        const displayDiv = document.getElementById(`location${playerId}Display`);

        if (!navigator.geolocation) {
            displayDiv.textContent = "‚ùå Geolocation not supported";
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            // LOAD CONFIG FIRST
            if (!apiConfig) {
                await loadApiConfig();
            }

            if (!apiConfig || !apiConfig.apiUrl || !apiConfig.apiKey) {
                displayDiv.textContent = "‚ùå API config missing";
                return;
            }

            // FETCH using OpenCage API logic
            try {
                const res = await fetch(`${apiConfig.apiUrl}?q=${lat}+${lon}&key=${apiConfig.apiKey}`);
                const data = await res.json();

                if (manualLocations[playerId]) return;

                const result = data.results && data.results[0];
                if (result) {
                    const components = result.components;
                    const city = components.city || components.town || components.village || components.county;
                    const country = components.country;

                    if (city && country) {
                        const code = countryCodeMap[country] || null;
                        const emoji = code ? toCountryCodeEmoji(code) : "üìç";
                        displayDiv.innerHTML = `${emoji} ${city}, ${country}`;
                    } else {
                        displayDiv.textContent = "‚ùå Location data incomplete";
                    }
                } else {
                    displayDiv.textContent = "‚ùå No results from API";
                }
            } catch (err) {
                displayDiv.textContent = "‚ùå Location fetch error";
                console.error("API error:", err);
            }
        }, () => {
            displayDiv.textContent = "‚ùå Permission denied or unavailable";
        });
    }

        // toggle manual field to enable both players to manually enter their location
        function toggleLocationInput(playerId) {
            const container = document.getElementById(`manualInput${playerId}`);
            const changeButton = document.querySelector(`#manualInput${playerId}`).previousElementSibling;

            const isVisible = container.style.display === "block";
            container.style.display = isVisible ? "none" : "block";

            // hide "Change Location" button while editing
            changeButton.style.display = isVisible ? "inline-block" : "none";
        }

        function setManualLocation(playerId) {
            const city = document.getElementById(`manualCity${playerId}`).value.trim();
            const country = document.getElementById(`manualCountry${playerId}`).value.trim();
            const displayDiv = document.getElementById(`location${playerId}Display`);

            if (city && country) {
                manualLocations[playerId] = { city, country };

                const code = countryCodeMap[country] || null;
                const countryCodeEmoji = code ? toCountryCodeEmoji(code) : "üìç";
                displayDiv.innerHTML = `${countryCodeEmoji} ${city}, ${country}<br>‚úèÔ∏è <em>Manually entered</em>`;
                
                document.getElementById(`manualInput${playerId}`).style.display = "none";

                // show the button again
                const changeButton = displayDiv.parentElement.querySelector("button");
                changeButton.style.display = "inline-block";
            } else {
                alert("Please enter both city and country.");
            }
        }
    </script>
</body>
</html>